<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_15401_data_gover.InsertRecordsIntoManyTable</api_name>
        <client_callable>false</client_callable>
        <description/>
        <name>InsertRecordsIntoManyTable</name>
        <script><![CDATA[var InsertRecordsIntoManyTable = Class.create();
InsertRecordsIntoManyTable.prototype = {
	initialize: function() {
	},
	
	
	
	syncRecordsDSR : function (sysId) {
		this.insertEncodedRecords('x_15401_data_gover_policy', 'apply_to_all=true^active=true', 'x_15401_data_gover_m2m_dsr_to_policy', 'data_sharing_request', 'policy', sysId, "sys_id");
		//Insert Policies that are based on data fields
		this.insertEncodedRecordsM2M('x_15401_data_gover_m2m_required_df_to_dsr', 'data_field.policyISNOTEMPTY^data_field.policy.active=true^data_sharing_request.sys_id=' + sysId, 'x_15401_data_gover_data_field', 'x_15401_data_gover_m2m_dsr_to_policy', 'data_sharing_request', 'policy', sysId, 'data_field');
		//Insert Policies that are based on additional data fields
		this.insertEncodedRecordsM2M('x_15401_data_gover_m2m_additional_df_to_dsr', 'data_field.policyISNOTEMPTY^data_field.policy.active=true^data_sharing_request.sys_id=' + sysId, 'x_15401_data_gover_data_field', 'x_15401_data_gover_m2m_dsr_to_policy', 'data_sharing_request', 'policy', sysId, 'data_field');
		//Insert Policies that are based on API
		this.insertEncodedRecordsM2M('x_15401_data_gover_m2m_dsr_to_api', 'api.policyISNOTEMPTY^api.policy.active=true^data_sharing_request.sys_id=' + sysId, 'x_15401_data_gover_api', 'x_15401_data_gover_m2m_dsr_to_policy', 'data_sharing_request', 'policy', sysId, 'api');
		//Find all the Communities Involved in the DSR that are required
		this.insertEncodedRecordsM2M('x_15401_data_gover_m2m_required_df_to_dsr', 'data_sharing_request.sys_id=' + sysId, 'x_15401_data_gover_data_field', 'x_15401_data_gover_m2m_dsr_to_community', 'data_sharing_request', 'community', sysId, 'data_field');
		//Find all the Communities Involved in the DSR by Additional Fields
		this.insertEncodedRecordsM2M('x_15401_data_gover_m2m_additional_df_to_dsr', 'data_sharing_request.sys_id=' + sysId, 'x_15401_data_gover_data_field', 'x_15401_data_gover_m2m_dsr_to_community', 'data_sharing_request', 'community', sysId, 'data_field');
	},
	
	//QueryTable = Table to get information form
	//EncodedQuery = Query to get the information
	//InsertTable = Table to store information
	//InsertField = Name of Field to Insert Information
	//InsertField2 = Second Field to Insert Information
	//Current = The id of store with InsertField
	//LookupValue = The Value to get from the EncodedQuery
	insertEncodedRecords : function (queryTable, encodedQuery, insertTable, insertField, insertField2, current, lookupValue) {
		var lookup = new GlideRecord(queryTable);
		lookup.addEncodedQuery(encodedQuery);
		lookup.query();
		while(lookup.next()) {
			var addRecord = new GlideRecord(insertTable);
			addRecord.addQuery(insertField, current);
			addRecord.addQuery(insertField2, lookup.getValue(lookupValue));
			addRecord.query();
			//Make sure we haven't inserted it already
			if(addRecord.hasNext()) {
				continue;
			}
			addRecord.initialize();
			addRecord.setValue(insertField, current);
			addRecord.setValue(insertField2, lookup.getValue(lookupValue));
			addRecord.insert();
		}
	},
	
	//QueryTable = Table to get information form
	//EncodedQuery = Query to get the information
	//LookupTable = Table to get sys_id of Many to Many Table
	//InsertTable = Table to store information
	//InsertField = Name of Field to Insert Information
	//InsertField2 = Second Field to Insert Information
	//Current = The id of store with InsertField
	//LookupValue = The Value to get from the EncodedQuery
	insertEncodedRecordsM2M : function (queryTable, encodedQuery, lookupTable, insertTable, insertField, insertField2, current, lookupValue) {
		var lookup = new GlideRecord(queryTable);
		lookup.addEncodedQuery(encodedQuery);
		lookup.query();
		while(lookup.next()) {
			var checkTable = new GlideRecord(lookupTable);
			if(checkTable.get(lookup.getValue(lookupValue))) {
				var addRecord = new GlideRecord(insertTable);
				addRecord.addQuery(insertField, current);
				addRecord.addQuery(insertField2, checkTable.getValue('sys_id'));
				addRecord.query();
				//Make sure we haven't inserted it already
				if(addRecord.hasNext()) {
					continue;
				}
				addRecord.initialize();
				addRecord.setValue(insertField, current);
				addRecord.setValue(insertField2, checkTable.getValue('sys_id'));
				addRecord.insert();
			}
		}
	},
	
	type: 'InsertRecordsIntoManyTable'
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>thirschi</sys_created_by>
        <sys_created_on>2019-01-15 01:31:11</sys_created_on>
        <sys_id>6f7dc0090fc3230055498f8ce1050ec7</sys_id>
        <sys_mod_count>21</sys_mod_count>
        <sys_name>InsertRecordsIntoManyTable</sys_name>
        <sys_package display_value="Data Governance" source="x_15401_data_gover">b869600e0f12230055498f8ce1050e47</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="Data Governance">b869600e0f12230055498f8ce1050e47</sys_scope>
        <sys_update_name>sys_script_include_6f7dc0090fc3230055498f8ce1050ec7</sys_update_name>
        <sys_updated_by>thirschi</sys_updated_by>
        <sys_updated_on>2019-03-15 05:44:44</sys_updated_on>
    </sys_script_include>
</record_update>
